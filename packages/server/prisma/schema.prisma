generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  encryptedKEK    String    @map("encrypted_kek")
  salt            String
  recoveryKeyHash String    @map("recovery_key_hash")
  role            String    @default("user") // "admin" | "user"
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  devices         Device[]
  notes           Note[]
  folders         Folder[]
  auditLogs       AuditLog[]
  shares          Share[]   @relation("ShareOwner")
  receivedShares  Share[]   @relation("ShareRecipient")
  
  @@map("users")
}

model SystemSettings {
  id                    String   @id @default("system")
  siteName              String   @default("Secure Notebook") @map("site_name")
  siteDescription       String   @default("End-to-end encrypted note-taking app") @map("site_description")
  allowRegistration     Boolean  @default(true) @map("allow_registration")
  maxUsersLimit         Int      @default(0) @map("max_users_limit") // 0 = unlimited
  maintenanceMode       Boolean  @default(false) @map("maintenance_mode")
  maintenanceMessage    String?  @map("maintenance_message")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  @@map("system_settings")
}

model Device {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  name        String
  publicKey   String    @map("public_key")
  lastSyncAt  DateTime? @map("last_sync_at")
  isVerified  Boolean   @default(false) @map("is_verified")
  createdAt   DateTime  @default(now()) @map("created_at")
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  auditLogs   AuditLog[]
  
  @@map("devices")
}

model Note {
  id                    String    @id @default(uuid())
  userId                String    @map("user_id")
  encryptedTitle        String    @map("encrypted_title")
  encryptedContent      String    @map("encrypted_content")
  encryptedDEK          String    @map("encrypted_dek")
  folderId              String?   @map("folder_id")
  isPinned              Boolean   @default(false) @map("is_pinned")
  pinnedAt              DateTime? @map("pinned_at")
  hasPassword           Boolean   @default(false) @map("has_password")
  passwordHash          String?   @map("password_hash")
  encryptedPasswordSalt String?   @map("encrypted_password_salt")
  visibility            String    @default("private")
  syncVersion           Int       @default(1) @map("sync_version")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  isDeleted             Boolean   @default(false) @map("is_deleted")
  deletedAt             DateTime? @map("deleted_at")
  
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  folder                Folder?   @relation(fields: [folderId], references: [id], onDelete: SetNull)
  versions              NoteVersion[]
  images                Image[]
  shares                Share[]
  tags                  NoteTag[]
  
  @@index([userId])
  @@index([folderId])
  @@index([isPinned])
  @@map("notes")
}

model NoteVersion {
  id               String   @id @default(uuid())
  noteId           String   @map("note_id")
  encryptedContent String   @map("encrypted_content")
  encryptedDEK     String   @map("encrypted_dek")
  size             Int
  createdAt        DateTime @default(now()) @map("created_at")
  
  note             Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  
  @@index([noteId])
  @@map("note_versions")
}

model Folder {
  id                String    @id @default(uuid())
  userId            String    @map("user_id")
  encryptedName     String    @map("encrypted_name")
  parentId          String?   @map("parent_id")
  order             Int       @default(0)
  hasPassword       Boolean   @default(false) @map("has_password")
  passwordHash      String?   @map("password_hash")
  passwordInherited Boolean   @default(false) @map("password_inherited")
  syncVersion       Int       @default(1) @map("sync_version")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  isDeleted         Boolean   @default(false) @map("is_deleted")
  deletedAt         DateTime? @map("deleted_at")
  
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent            Folder?   @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children          Folder[]  @relation("FolderHierarchy")
  notes             Note[]
  
  @@index([userId])
  @@index([parentId])
  @@map("folders")
}

model Image {
  id                String    @id @default(uuid())
  noteId            String    @map("note_id")
  encryptedData     String    @map("encrypted_data")
  mimeType          String    @map("mime_type")
  size              Int
  checksum          String
  markedForDeletion Boolean   @default(false) @map("marked_for_deletion")
  deletionDate      DateTime? @map("deletion_date")
  createdAt         DateTime  @default(now()) @map("created_at")
  
  note              Note      @relation(fields: [noteId], references: [id], onDelete: Cascade)
  
  @@index([noteId])
  @@map("images")
}

model AuditLog {
  id                 String   @id @default(uuid())
  userId             String   @map("user_id")
  action             String
  deviceId           String?  @map("device_id")
  encryptedIpAddress String   @map("encrypted_ip_address")
  userAgent          String   @map("user_agent")
  metadata           Json?
  createdAt          DateTime @default(now()) @map("created_at")
  
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  device             Device?  @relation(fields: [deviceId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Share {
  id                 String    @id @default(uuid())
  noteId             String    @map("note_id")
  ownerId            String    @map("owner_id")
  recipientId        String?   @map("recipient_id")
  recipientEmail     String    @map("recipient_email")
  encryptedShareKey  String    @map("encrypted_share_key")
  permission         String    @default("view")
  createdAt          DateTime  @default(now()) @map("created_at")
  expiresAt          DateTime? @map("expires_at")
  isRevoked          Boolean   @default(false) @map("is_revoked")
  
  note               Note      @relation(fields: [noteId], references: [id], onDelete: Cascade)
  owner              User      @relation("ShareOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  recipient          User?     @relation("ShareRecipient", fields: [recipientId], references: [id], onDelete: SetNull)
  
  @@index([noteId])
  @@index([ownerId])
  @@index([recipientEmail])
  @@map("shares")
}

model NoteTag {
  id        String   @id @default(uuid())
  noteId    String   @map("note_id")
  tag       String
  createdAt DateTime @default(now()) @map("created_at")
  
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  
  @@unique([noteId, tag])
  @@index([tag])
  @@map("note_tags")
}

model Backup {
  id         String   @id @default(uuid())
  userId     String   @map("user_id")
  type       String   // 'webdav' or 'cloud'
  size       Int
  checksum   String
  noteCount  Int      @map("note_count")
  folderCount Int     @map("folder_count")
  createdAt  DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([type])
  @@map("backups")
}
