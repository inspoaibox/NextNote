# 安全架构文档

本文档详细说明 Secure Notebook 的安全设计和实现。

## 目录

1. [加密架构](#加密架构)
2. [密钥管理](#密钥管理)
3. [数据保护](#数据保护)
4. [认证与授权](#认证与授权)
5. [安全最佳实践](#安全最佳实践)

---

## 加密架构

### 端到端加密 (E2E)

Secure Notebook 采用端到端加密架构，确保：
- 所有笔记内容在客户端加密后再传输
- 服务器只存储密文，无法解密用户数据
- 即使数据库泄露，攻击者也无法读取笔记内容

### 加密算法

| 用途 | 算法 | 密钥长度 |
|------|------|----------|
| 内容加密 | AES-256-GCM | 256 bits |
| 密钥包装 | AES-256-KW | 256 bits |
| 密钥派生 | Argon2id | - |
| 密钥扩展 | HKDF-SHA256 | - |
| 完整性校验 | HMAC-SHA256 | 256 bits |

### 加密流程

```
用户密码
    │
    ▼ Argon2id (iterations=3, memory=64MB)
主密钥 (Master Key)
    │
    ▼ HKDF-SHA256
密钥加密密钥 (KEK)
    │
    ├──▶ 包装 DEK (AES-256-KW)
    │
    ▼
数据加密密钥 (DEK) ──▶ 加密笔记内容 (AES-256-GCM)
```

---

## 密钥管理

### 密钥层次结构

1. **主密钥 (Master Key)**
   - 从用户密码派生
   - 使用 Argon2id 算法
   - 参数: iterations=3, memory=64MB, parallelism=1
   - 每个用户唯一的盐值

2. **密钥加密密钥 (KEK)**
   - 从主密钥使用 HKDF 派生
   - 用于包装/解包装 DEK
   - 加密后存储在服务器

3. **数据加密密钥 (DEK)**
   - 每个笔记唯一
   - 256位随机生成
   - 使用 KEK 包装后存储

### 恢复密钥

- 注册时生成 24 词助记词 (BIP39)
- 仅显示一次，用户需安全保存
- 可用于密码重置而不丢失数据
- 从助记词可派生出与主密钥等效的密钥

### 密钥存储

| 密钥类型 | 存储位置 | 加密状态 |
|----------|----------|----------|
| 主密钥 | 内存 (会话期间) | 明文 |
| KEK | 服务器 | 使用主密钥加密 |
| DEK | 服务器 | 使用 KEK 包装 |
| 恢复密钥 | 用户保管 | 明文 |

### 密钥轮换

密码变更时：
1. 使用旧密码解密 KEK
2. 使用新密码重新加密 KEK
3. 所有 DEK 保持不变
4. 笔记内容无需重新加密

---

## 数据保护

### 笔记加密

每个笔记包含：
- `encryptedTitle`: 加密的标题
- `encryptedContent`: 加密的内容
- `encryptedDEK`: 包装的 DEK
- `iv`: 初始化向量 (每次加密唯一)
- `authTag`: 认证标签 (GCM 模式)

### 笔记密码保护

为敏感笔记添加额外保护：

```
笔记密码
    │
    ▼ Argon2id
二级密钥
    │
    ▼
双重加密: 主密钥加密 → 二级密钥加密
```

特性：
- 5次密码错误后锁定5分钟
- 可使用账户恢复密钥重置笔记密码
- 支持文件夹级别密码保护

### 图片加密

- 图片使用笔记的 DEK 加密
- 支持最大 5MB 图片
- 删除笔记后图片标记为待删除
- 30天后永久删除

### 搜索索引

- 搜索索引在本地加密存储
- 使用 IndexedDB 存储
- 内容变更时重建索引

---

## 认证与授权

### 用户认证

1. **注册流程**
   - 生成唯一盐值
   - 派生主密钥和 KEK
   - 生成恢复密钥
   - 存储加密的 KEK 和盐值

2. **登录流程**
   - 获取用户盐值
   - 派生主密钥
   - 解密 KEK
   - 生成 JWT 令牌

### JWT 令牌

- 有效期: 7天
- 包含: userId, deviceId, exp
- 使用 HS256 签名
- 生产环境必须设置 JWT_SECRET 环境变量

### 速率限制

| 端点 | 限制 | 窗口 |
|------|------|------|
| 登录/注册 | 10次 | 15分钟 |
| API 请求 | 60次 | 1分钟 |
| 密码尝试 | 5次 | 锁定15分钟 |

### 登录保护

- 5次失败后账户锁定15分钟
- 使用时间恒定比较防止时序攻击
- IP 地址加密存储在审计日志中

### 设备管理

- 每个设备有唯一 ID
- 新设备需要验证
- 支持撤销所有设备会话

### 分享权限

| 权限级别 | 查看 | 编辑 |
|----------|------|------|
| view | ✅ | ❌ |
| edit | ✅ | ✅ |

分享流程：
1. 生成唯一分享密钥
2. 使用接收者公钥加密
3. 服务器验证权限
4. 撤销时重新加密笔记

---

## 安全最佳实践

### 服务器安全

1. **传输安全**
   - 强制 HTTPS (TLS 1.3)
   - HSTS 头部
   - 证书固定 (可选)

2. **HTTP 安全头**
   ```
   Strict-Transport-Security: max-age=31536000; includeSubDomains
   X-Content-Type-Options: nosniff
   X-Frame-Options: DENY
   X-XSS-Protection: 1; mode=block
   Content-Security-Policy: default-src 'self'
   ```

3. **速率限制**
   - 登录/注册: 10次/15分钟
   - API: 60次/分钟
   - 密码尝试: 5次后锁定15分钟

4. **输入验证**
   - 所有用户输入进行清理
   - 邮箱格式验证
   - 字符串长度限制
   - 防止 XSS 攻击

### 客户端安全

1. **密钥清理**
   - 会话结束时清除内存中的密钥
   - 100ms 内完成清理

2. **本地存储**
   - 使用 IndexedDB 加密存储
   - 不在 localStorage 存储敏感数据

3. **输入验证**
   - 所有用户输入进行验证
   - 防止 XSS 攻击

### 审计日志

记录以下事件：
- 登录/登出
- 密码变更
- 设备添加/移除
- 分享创建/撤销
- 异常访问尝试

日志包含：
- 时间戳
- 设备信息
- IP 地址 (加密存储)
- 操作类型

### 备份安全

1. **WebDAV 备份**
   - 凭据使用设备密钥加密
   - 备份数据保持加密状态
   - SHA-256 校验和验证

2. **云备份**
   - 仅上传加密数据
   - 保留最近30个版本
   - 支持时间点恢复

---

## 安全检查清单

### 部署前检查

- [ ] 使用强 JWT_SECRET (至少32字符)
- [ ] 配置 HTTPS
- [ ] 设置安全 HTTP 头
- [ ] 配置防火墙规则
- [ ] 启用数据库 SSL 连接
- [ ] 设置速率限制
- [ ] 配置日志记录

### 定期检查

- [ ] 审查审计日志
- [ ] 检查依赖漏洞 (`pnpm audit`)
- [ ] 更新依赖版本
- [ ] 备份数据库
- [ ] 测试恢复流程

---

## 漏洞报告

如发现安全漏洞，请通过以下方式报告：
- Email: security@your-domain.com
- 请勿公开披露，我们会在修复后致谢

响应时间：
- 确认收到: 24小时内
- 初步评估: 72小时内
- 修复发布: 根据严重程度
